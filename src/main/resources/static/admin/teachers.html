<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆä¿¡æ¯å±•ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* åˆ†é¡µæ§ä»¶æ ·å¼ */
        .pagination-container {
            display: none;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 0 20px 20px;
        }

        .pagination-info {
            font-size: 14px;
            color: #666;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pagination-btn {
            padding: 6px 12px;
            border: 1px solid #d9d9d9;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: #1890ff;
            color: #1890ff;
        }

        .pagination-btn:disabled {
            cursor: not-allowed;
            color: #bfbfbf;
            background-color: #f5f5f5;
        }

        .pagination-btn.active {
            background-color: #1890ff;
            border-color: #1890ff;
            color: white;
        }

        .pagination-ellipsis {
            padding: 0 8px;
            color: #666;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background-color: #1890ff;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .course-info {
            background-color: #f0f2f5;
            padding: 15px 20px;
            font-size: 14px;
            border-bottom: 1px solid #e8e8e8;
        }

        .course-info span {
            margin-right: 20px;
            color: #666;
        }

        .course-info strong {
            color: #333;
        }

        .content {
            padding: 20px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 16px;
            color: #666;
        }

        .empty-state {
            display: none;
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
        }

        .empty-state p {
            font-size: 16px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background-color: #fafafa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e8e8e8;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #666;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding: 0 20px 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #1890ff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #40a9ff;
        }

        .btn-default {
            background-color: #f5f5f5;
            color: #333;
        }

        .btn-default:hover {
            background-color: #e8e8e8;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 20px;
            }

            .course-info {
                padding: 10px;
                font-size: 12px;
            }

            .course-info span {
                display: block;
                margin-right: 0;
                margin-bottom: 5px;
            }

            .content {
                padding: 15px;
            }

            th,
            td {
                padding: 8px;
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>æ•™å¸ˆä¿¡æ¯å±•ç¤º</h1>
        </div>
        <div class="course-info">
            <span><strong>å­¦æœŸ:</strong> <span id="currentSemester">--</span></span>
            <span><strong>è¯¾ç¨‹åç§°:</strong> <span id="currentCourseName">--</span></span>
        </div>
        <div class="content">
            <div id="loading" class="loading">åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</div>
            <div id="emptyState" class="empty-state">
                <i>ğŸ“š</i>
                <p>æš‚æ— æ•™å¸ˆä¿¡æ¯</p>
            </div>
            <div id="tableContainer" class="table-container" style="display: none;">
                <table id="teachersTable">
                    <thead>
                        <tr>
                            <th>é€‰æ‹©</th>
                            <th>åºå·</th>
                            <th>è¯¾ç¨‹ä»£ç </th>
                            <th>è¯¾ç¨‹åç§°</th>
                            <th>æ•™å¸ˆå§“å</th>
                            <th>èŒç§°</th>
                            <th>æ•™å­¦ç­</th>
                            <th>å¼€è¯¾éƒ¨é—¨</th>
                            <th>æ—¶é—´åœ°ç‚¹</th>
                            <th>å­¦åˆ†</th>
                            <th>è¯¾ç¨‹æ€§è´¨</th>
                            <th>æ ¡åŒº</th>
                        </tr>
                    </thead>
                    <tbody id="teachersTableBody">
                    </tbody>
                </table>
            </div>
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div id="paginationContainer" class="pagination-container">
                <div class="pagination-info">
                    å…± <span id="totalItems">0</span> æ¡è®°å½•ï¼Œç¬¬ <span id="currentPage">1</span> / <span
                        id="totalPages">0</span> é¡µ
                </div>
                <div class="pagination-controls">
                    <button id="prevPageBtn" class="pagination-btn" disabled>ä¸Šä¸€é¡µ</button>
                    <div id="pageButtons" class="pagination-buttons"></div>
                    <button id="nextPageBtn" class="pagination-btn" disabled>ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
        <div class="action-buttons">
            <button id="backBtn" class="btn btn-default">è¿”å›è¯¾ç¨‹åˆ—è¡¨</button>
            <button id="refreshBtn" class="btn btn-primary">åˆ·æ–°æ•°æ®</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // è·å–DOMå…ƒç´ 
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('emptyState');
            const tableContainer = document.getElementById('tableContainer');
            const teachersTableBody = document.getElementById('teachersTableBody');
            const currentSemester = document.getElementById('currentSemester');
            const currentCourseName = document.getElementById('currentCourseName');
            const backBtn = document.getElementById('backBtn');
            const refreshBtn = document.getElementById('refreshBtn');

            // åˆ†é¡µç›¸å…³DOMå…ƒç´ 
            const paginationContainer = document.getElementById('paginationContainer');
            const totalItems = document.getElementById('totalItems');
            const currentPage = document.getElementById('currentPage');
            const totalPages = document.getElementById('totalPages');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const pageButtons = document.getElementById('pageButtons');

            // åˆ†é¡µç›¸å…³å˜é‡
            let pageSize = 10; // æ¯é¡µæ˜¾ç¤º10æ¡è®°å½•
            let currentPageNum = 1;
            let totalRecords = 0;
            let allTeachers = []; // å­˜å‚¨æ‰€æœ‰æ•™å¸ˆæ•°æ®

            // è·å–URLå‚æ•°
            function getUrlParams() {
                const params = {};
                const urlParams = new URLSearchParams(window.location.search);
                for (const [key, value] of urlParams) {
                    params[key] = decodeURIComponent(value);
                }
                return params;
            }

            const params = getUrlParams();
            const semester = params.semester || '';
            const courseName = params.courseName || '';

            // æ˜¾ç¤ºå½“å‰è¯¾ç¨‹ä¿¡æ¯
            currentSemester.textContent = semester || 'æœªçŸ¥';
            currentCourseName.textContent = courseName || 'æœªçŸ¥';

            // æ£€æŸ¥æ˜¯å¦å¤„äºåˆ›å»ºä»»åŠ¡æ¨¡å¼
            const isCreateTaskMode = params.createTask === 'true';

            // å¦‚æœæ˜¯åˆ›å»ºä»»åŠ¡æ¨¡å¼ï¼Œæ·»åŠ æç¤º
            if (isCreateTaskMode) {
                const taskModeIndicator = document.createElement('div');
                taskModeIndicator.className = 'task-mode-indicator';
                taskModeIndicator.style.cssText = 'background-color: #e6f7ff; padding: 10px 20px; text-align: center; font-weight: bold; color: #1890ff;';
                taskModeIndicator.textContent = 'åˆ›å»ºä»»åŠ¡æ¨¡å¼ - è¯·é€‰æ‹©éœ€è¦è¯„ä»·çš„æ•™å¸ˆ';

                const container = document.querySelector('.container');
                const header = document.querySelector('.header');
                container.insertBefore(taskModeIndicator, header.nextElementSibling);
            }

            // åŠ è½½æ•™å¸ˆæ•°æ®
            function loadTeachers() {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                loading.style.display = 'flex';
                emptyState.style.display = 'none';
                tableContainer.style.display = 'none';
                paginationContainer.style.display = 'none';
                teachersTableBody.innerHTML = '';

                // å¦‚æœå‚æ•°ä¸å®Œæ•´ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                if (!semester || !courseName) {
                    loading.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                // è°ƒç”¨APIè·å–æ•™å¸ˆæ•°æ®
                fetch(`/api/teachers/list?semester=${encodeURIComponent(semester)}&courseName=${encodeURIComponent(courseName)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                        }
                        return response.json();
                    })
                    .then(teachers => {
                        loading.style.display = 'none';

                        // å­˜å‚¨æ‰€æœ‰æ•™å¸ˆæ•°æ®
                        allTeachers = teachers || [];
                        totalRecords = allTeachers.length;

                        if (totalRecords === 0) {
                            emptyState.style.display = 'block';
                            return;
                        }

                        tableContainer.style.display = 'block';

                        // ä½¿ç”¨åˆ†é¡µå‡½æ•°æ¸²æŸ“æ•°æ®
                        renderTeachersWithPagination();
                    })
                    .catch(error => {
                        console.error('åŠ è½½æ•™å¸ˆæ•°æ®å¤±è´¥:', error);
                        loading.innerHTML = '<span style="color: #ff4d4f;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</span>';
                    });
            }

            // æ¸²æŸ“åˆ†é¡µæŒ‰é’®
            function renderPagination() {
                if (totalRecords === 0) {
                    paginationContainer.style.display = 'none';
                    return;
                }

                paginationContainer.style.display = 'flex';

                const totalPagesNum = Math.ceil(totalRecords / pageSize);
                console.log('åˆ†é¡µä¿¡æ¯æ›´æ–°:', { totalRecords, pageSize, currentPageNum, totalPagesNum });

                // æ›´æ–°åˆ†é¡µä¿¡æ¯
                totalItems.textContent = totalRecords;
                currentPage.textContent = currentPageNum;
                totalPages.textContent = totalPagesNum;

                // æ›´æ–°ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µæŒ‰é’®çŠ¶æ€
                prevPageBtn.disabled = currentPageNum === 1;
                nextPageBtn.disabled = currentPageNum === totalPagesNum;

                // æ¸…ç©ºé¡µç æŒ‰é’®
                pageButtons.innerHTML = '';

                // ç”Ÿæˆåˆ†é¡µæŒ‰é’®ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œæœ€å¤šæ˜¾ç¤º10ä¸ªé¡µç ï¼‰
                let startPage = Math.max(1, currentPageNum - 4);
                let endPage = Math.min(totalPagesNum, startPage + 9);

                // è°ƒæ•´èµ·å§‹é¡µç ï¼Œç¡®ä¿æ˜¾ç¤º10ä¸ªé¡µç ï¼ˆå¦‚æœæ€»é¡µæ•°è¶³å¤Ÿï¼‰
                if (endPage - startPage < 9 && startPage > 1) {
                    startPage = Math.max(1, endPage - 9);
                }

                // æ˜¾ç¤ºç¬¬ä¸€é¡µå’Œçœç•¥å·ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if (startPage > 1) {
                    addPageButton(1);
                    if (startPage > 2) {
                        addEllipsis();
                    }
                }

                // æ˜¾ç¤ºä¸­é—´çš„é¡µç 
                for (let i = startPage; i <= endPage; i++) {
                    addPageButton(i);
                }

                // æ˜¾ç¤ºæœ€åä¸€é¡µå’Œçœç•¥å·ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if (endPage < totalPagesNum) {
                    if (endPage < totalPagesNum - 1) {
                        addEllipsis();
                    }
                    addPageButton(totalPagesNum);
                }
            }

            // æ·»åŠ é¡µç æŒ‰é’®
            function addPageButton(pageNum) {
                const button = document.createElement('button');
                button.className = 'pagination-btn';
                button.textContent = pageNum;

                if (pageNum === currentPageNum) {
                    button.classList.add('active');
                }

                button.addEventListener('click', () => {
                    currentPageNum = pageNum;
                    renderTeachersWithPagination();
                });

                pageButtons.appendChild(button);
            }

            // æ·»åŠ çœç•¥å·
            function addEllipsis() {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'pagination-ellipsis';
                ellipsis.textContent = '...';
                pageButtons.appendChild(ellipsis);
            }

            // æ¢å¤å¤é€‰æ¡†çš„å‹¾é€‰çŠ¶æ€
            function restoreCheckboxStates() {
                if (isCreateTaskMode) {
                    const selectedTeachers = JSON.parse(localStorage.getItem('selectedTeachers') || '[]');
                    document.querySelectorAll('.teacher-select-checkbox').forEach(checkbox => {
                        const courseCode = checkbox.dataset.courseCode;
                        const teacherName = checkbox.dataset.teacherName;

                        // æ£€æŸ¥æ˜¯å¦åœ¨å·²é€‰æ‹©åˆ—è¡¨ä¸­
                        const isSelected = selectedTeachers.some(t =>
                            t.courseCode === courseCode && t.teacherName === teacherName
                        );

                        checkbox.checked = isSelected;
                    });
                }
            }

            // åˆ†é¡µæ¸²æŸ“æ•™å¸ˆæ•°æ®
            function renderTeachersWithPagination() {
                const startIndex = (currentPageNum - 1) * pageSize;
                const endIndex = startIndex + pageSize;
                const currentPageTeachers = allTeachers.slice(startIndex, endIndex);
                console.log('æ¸²æŸ“ç¬¬', currentPageNum, 'é¡µæ•°æ®ï¼Œæ˜¾ç¤ºè®°å½•èŒƒå›´:', startIndex + 1, '-', endIndex, 'å…±', currentPageTeachers.length, 'æ¡è®°å½•');

                // æ¸…ç©ºè¡¨æ ¼å†…å®¹
                teachersTableBody.innerHTML = '';

                // æ¸²æŸ“å½“å‰é¡µçš„æ•°æ®
                currentPageTeachers.forEach((teacher, index) => {
                    const row = document.createElement('tr');
                    const displayIndex = startIndex + index + 1; // æ­£ç¡®çš„åºå·æ˜¾ç¤º
                    let checkboxHtml = '';
                    if (isCreateTaskMode) {
                        checkboxHtml = `
                        <td>
                            <input type="checkbox" class="teacher-select-checkbox" 
                                   data-course-code="${teacher.courseCode || '-'}"
                                   data-course-name="${teacher.courseName || '-'}"
                                   data-teacher-name="${teacher.teacher || '-'}"
                                   data-title="${teacher.title || '-'}"
                                   data-department="${teacher.department || '-'}"
                                   data-nature="${teacher.nature || '-'}">
                        </td>`;
                    }

                    row.innerHTML = `${checkboxHtml}
                        <td>${displayIndex}</td>
                        <td>${teacher.courseCode || '-'}</td>
                        <td>${teacher.courseName || '-'}</td>
                        <td>${teacher.teacher || '-'}</td>
                        <td>${teacher.title || '-'}</td>
                        <td>${teacher.teachingClass || '-'}</td>
                        <td>${teacher.department || '-'}</td>
                        <td>${teacher.timeLocation || '-'}</td>
                        <td>${teacher.credits || '-'}</td>
                        <td>${teacher.nature || '-'}</td>
                        <td>${teacher.campus || '-'}</td>
                    `;
                    teachersTableBody.appendChild(row);
                });

                // æ›´æ–°åˆ†é¡µæ§ä»¶
                renderPagination();

                // æ¢å¤å¤é€‰æ¡†çŠ¶æ€
                restoreCheckboxStates();
            }

            // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨ä¸­çš„é€‰ä¸­æ•™å¸ˆåˆ—è¡¨
            if (isCreateTaskMode && !localStorage.getItem('selectedTeachers')) {
                localStorage.setItem('selectedTeachers', JSON.stringify([]));
            }

            // æ·»åŠ å·²é€‰æ‹©è¯¾ç¨‹çš„å±•ç¤ºåŒºåŸŸ
            function addSelectedCoursesSection() {
                if (isCreateTaskMode) {
                    // åœ¨æ•™å¸ˆè¡¨æ ¼ä¸Šæ–¹æ·»åŠ é€‰ä¸­è¯¾ç¨‹å±•ç¤ºåŒºåŸŸ
                    const section = document.createElement('div');
                    section.className = 'selected-courses-section';
                    section.innerHTML = `
                        <div class="section-header">
                            <h4>å·²é€‰æ‹©è¯¾ç¨‹ (<span id="selected-count">0</span>)</h4>
                            <button id="toggle-selection-btn" class="btn btn-sm btn-outline-primary">æ”¶èµ·</button>
                        </div>
                        <div id="selected-courses-container" class="selected-courses-container">
                            <div id="selected-courses-list" class="selected-courses-list">
                                <p class="no-selection">æš‚æ— å·²é€‰æ‹©è¯¾ç¨‹</p>
                            </div>
                        </div>
                    `;

                    // æ·»åŠ æ ·å¼
                    const style = document.createElement('style');
                    style.textContent = `
                        .selected-courses-section {
                            margin-bottom: 20px;
                            border: 1px solid #e9ecef;
                            border-radius: 4px;
                            overflow: hidden;
                        }
                        .section-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 10px 15px;
                            background-color: #f8f9fa;
                            border-bottom: 1px solid #e9ecef;
                        }
                        .section-header h4 {
                            margin: 0;
                            font-size: 16px;
                        }
                        .selected-courses-container {
                            max-height: 300px;
                            overflow-y: auto;
                            transition: max-height 0.3s ease;
                        }
                        .selected-courses-container.collapsed {
                            max-height: 0;
                            overflow: hidden;
                        }
                        .selected-courses-list {
                            padding: 10px 15px;
                        }
                        .selected-course-item {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 8px;
                            margin-bottom: 5px;
                            background-color: #f8f9fa;
                            border-radius: 4px;
                            border-left: 3px solid #007bff;
                        }
                        .selected-course-info {
                            flex: 1;
                        }
                        .selected-course-delete {
                            background-color: #dc3545;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            padding: 4px 8px;
                            cursor: pointer;
                            font-size: 12px;
                        }
                        .selected-course-delete:hover {
                            background-color: #c82333;
                        }
                        .no-selection {
                            text-align: center;
                            color: #6c757d;
                            font-style: italic;
                        }
                    `;
                    document.head.appendChild(style);

                    // æ’å…¥åˆ°è¡¨æ ¼ä¸Šæ–¹
                    const tableWrapper = document.querySelector('.table-responsive');
                    if (tableWrapper) {
                        tableWrapper.parentNode.insertBefore(section, tableWrapper);
                    } else {
                        // å¤‡ç”¨æ–¹æ¡ˆï¼šæ’å…¥åˆ°é¡µé¢é¡¶éƒ¨çš„contentåŒºåŸŸ
                        const mainContent = document.querySelector('.content');
                        if (mainContent) {
                            const firstChild = mainContent.firstChild;
                            if (firstChild) {
                                mainContent.insertBefore(section, firstChild);
                            } else {
                                mainContent.appendChild(section);
                            }
                        } else {
                            console.error('æ— æ³•æ‰¾åˆ°åˆé€‚çš„ä½ç½®æ’å…¥é€‰ä¸­è¯¾ç¨‹å±•ç¤ºåŒºåŸŸ');
                        }
                    }

                    // åŠ è½½åˆå§‹é€‰ä¸­çš„è¯¾ç¨‹
                    updateSelectedCoursesDisplay();

                    // æ·»åŠ æŠ˜å /å±•å¼€äº‹ä»¶ç›‘å¬
                    const toggleBtn = document.getElementById('toggle-selection-btn');
                    const container = document.getElementById('selected-courses-container');

                    if (toggleBtn && container) {
                        toggleBtn.addEventListener('click', function () {
                            container.classList.toggle('collapsed');
                            this.textContent = container.classList.contains('collapsed') ? 'å±•å¼€' : 'æ”¶èµ·';
                        });
                    }
                }
            }

            // æ›´æ–°å·²é€‰æ‹©è¯¾ç¨‹çš„æ˜¾ç¤º
            function updateSelectedCoursesDisplay() {
                try {
                    // ç¡®ä¿localStorageä¸­æœ‰æ•°æ®ç»“æ„
                    if (!localStorage.getItem('selectedTeachers')) {
                        localStorage.setItem('selectedTeachers', JSON.stringify([]));
                    }

                    // å®‰å…¨åœ°è§£ælocalStorageæ•°æ®
                    let selectedTeachers = [];
                    try {
                        selectedTeachers = JSON.parse(localStorage.getItem('selectedTeachers') || '[]');
                        if (!Array.isArray(selectedTeachers)) {
                            selectedTeachers = [];
                            localStorage.setItem('selectedTeachers', JSON.stringify([]));
                        }
                    } catch (e) {
                        console.error('è§£æselectedTeachersæ•°æ®å‡ºé”™:', e);
                        selectedTeachers = [];
                        localStorage.setItem('selectedTeachers', JSON.stringify([]));
                    }

                    // æŸ¥æ‰¾DOMå…ƒç´ 
                    const listElement = document.getElementById('selected-courses-list');
                    const countElement = document.getElementById('selected-count');
                    const container = document.getElementById('selected-courses-container');

                    // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œé‡æ–°æŸ¥æ‰¾å’Œåˆ›å»º
                    if (!listElement || !countElement) {
                        console.log('é‡æ–°åˆ›å»ºé€‰ä¸­è¯¾ç¨‹å±•ç¤ºåŒºåŸŸ');
                        addSelectedCoursesSection();
                        return;
                    }

                    // ç¡®ä¿å®¹å™¨ä¸å¤„äºæŠ˜å çŠ¶æ€
                    if (container && container.classList.contains('collapsed') && selectedTeachers.length > 0) {
                        container.classList.remove('collapsed');
                        const toggleBtn = document.getElementById('toggle-selection-btn');
                        if (toggleBtn) {
                            toggleBtn.textContent = 'æ”¶èµ·';
                        }
                    }

                    // æ›´æ–°è®¡æ•°
                    countElement.textContent = selectedTeachers.length;

                    // æ¸…ç©ºåˆ—è¡¨
                    listElement.innerHTML = '';

                    // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„è¯¾ç¨‹
                    if (selectedTeachers.length === 0) {
                        listElement.innerHTML = '<p class="no-selection">æš‚æ— å·²é€‰æ‹©è¯¾ç¨‹</p>';
                        return;
                    }

                    // æ·»åŠ æ¯ä¸ªé€‰ä¸­çš„è¯¾ç¨‹
                    selectedTeachers.forEach(teacher => {
                        if (teacher && teacher.courseCode && teacher.teacherName) {
                            const item = document.createElement('div');
                            item.className = 'selected-course-item';
                            item.dataset.courseCode = teacher.courseCode;
                            item.dataset.teacherName = teacher.teacherName;
                            item.innerHTML = `
                                <div class="selected-course-info">
                                    <strong>${teacher.courseName || 'æœªçŸ¥è¯¾ç¨‹'}</strong> (${teacher.courseCode})<br>
                                    æ•™å¸ˆ: ${teacher.teacherName} | éƒ¨é—¨: ${teacher.department || 'æœªçŸ¥'}
                                </div>
                                <button class="selected-course-delete" title="åˆ é™¤é€‰æ‹©">åˆ é™¤</button>
                            `;
                            listElement.appendChild(item);
                        }
                    });

                    // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬ï¼ˆä½¿ç”¨å§”æ‰˜æ–¹å¼é¿å…é‡å¤ç»‘å®šï¼‰
                    listElement.onclick = function (event) {
                        if (event.target.classList.contains('selected-course-delete')) {
                            const item = event.target.closest('.selected-course-item');
                            const courseCode = item.dataset.courseCode;
                            const teacherName = item.dataset.teacherName;

                            // ä»localStorageä¸­ç§»é™¤
                            let selectedTeachers = JSON.parse(localStorage.getItem('selectedTeachers') || '[]');
                            selectedTeachers = selectedTeachers.filter(t =>
                                !(t.courseCode === courseCode && t.teacherName === teacherName)
                            );
                            localStorage.setItem('selectedTeachers', JSON.stringify(selectedTeachers));

                            // æ›´æ–°æ˜¾ç¤º
                            updateSelectedCoursesDisplay();

                            // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
                            document.querySelectorAll('.teacher-select-checkbox').forEach(checkbox => {
                                if (checkbox.dataset.courseCode === courseCode &&
                                    checkbox.dataset.teacherName === teacherName) {
                                    checkbox.checked = false;
                                }
                            });
                        }
                    };
                } catch (error) {
                    console.error('æ›´æ–°å·²é€‰æ‹©è¯¾ç¨‹æ˜¾ç¤ºæ—¶å‡ºé”™:', error);
                }
            }

            // åˆå§‹åŠ è½½æ•°æ®
            loadTeachers();

            // æ·»åŠ å·²é€‰æ‹©è¯¾ç¨‹å±•ç¤ºåŒºåŸŸ
            addSelectedCoursesSection();

            // æ·»åŠ å¤é€‰æ¡†ç‚¹å‡»äº‹ä»¶å¤„ç†
            document.addEventListener('change', function (event) {
                if (event.target.classList.contains('teacher-select-checkbox')) {
                    const checkbox = event.target;
                    const selectedTeachers = JSON.parse(localStorage.getItem('selectedTeachers') || '[]');

                    const teacherInfo = {
                        courseCode: checkbox.dataset.courseCode,
                        courseName: checkbox.dataset.courseName,
                        teacherName: checkbox.dataset.teacherName,
                        title: checkbox.dataset.title,
                        department: checkbox.dataset.department,
                        nature: checkbox.dataset.nature
                    };

                    if (checkbox.checked) {
                        // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
                        selectedTeachers.push(teacherInfo);
                    } else {
                        // ä»é€‰ä¸­åˆ—è¡¨ä¸­ç§»é™¤
                        const index = selectedTeachers.findIndex(item =>
                            item.courseCode === teacherInfo.courseCode &&
                            item.teacherName === teacherInfo.teacherName
                        );
                        if (index > -1) {
                            selectedTeachers.splice(index, 1);
                        }
                    }

                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('selectedTeachers', JSON.stringify(selectedTeachers));

                    // æ›´æ–°å·²é€‰æ‹©è¯¾ç¨‹çš„æ˜¾ç¤º
                    updateSelectedCoursesDisplay();
                }
            });

            // è¿”å›æŒ‰é’®äº‹ä»¶å¤„ç†ï¼ˆå¢å¼ºç‰ˆï¼‰
            function setupBackButton() {
                // å°è¯•è·å–è¿”å›æŒ‰é’®çš„å¤šç§æ–¹å¼
                const backBtn = document.getElementById('backBtn') ||
                    document.querySelector('[id*="back"],[class*="back"]') ||
                    document.querySelector('button:contains("è¿”å›")') ||
                    document.querySelector('a:contains("è¿”å›")');

                if (backBtn) {
                    console.log('æ‰¾åˆ°è¿”å›æŒ‰é’®ï¼Œç»‘å®šäº‹ä»¶');
                    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
                    const newBackBtn = backBtn.cloneNode(true);
                    backBtn.parentNode.replaceChild(newBackBtn, backBtn);

                    // é‡æ–°ç»‘å®šäº‹ä»¶
                    newBackBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        console.log('è¿”å›æŒ‰é’®ç‚¹å‡»');
                        if (isCreateTaskMode) {
                            console.log('è·³è½¬åˆ°: courses.html?createTask=true');
                            window.location.href = 'courses.html?createTask=true';
                        } else {
                            console.log('è·³è½¬åˆ°: courses.html');
                            window.location.href = 'courses.html';
                        }
                    });
                } else {
                    console.error('æœªæ‰¾åˆ°è¿”å›æŒ‰é’®');
                    // æ·»åŠ å¤‡ç”¨æ–¹æ¡ˆï¼šåœ¨é¡µé¢é¡¶éƒ¨æ·»åŠ è¿”å›é“¾æ¥
                    const backLink = document.createElement('div');
                    backLink.className = 'back-link-container';
                    backLink.innerHTML = `
                        <a href="courses.html${isCreateTaskMode ? '?createTask=true' : ''}" 
                           class="btn btn-primary back-link">
                            è¿”å›è¯¾ç¨‹åˆ—è¡¨
                        </a>
                    `;

                    const mainContent = document.querySelector('.content') ||
                        document.querySelector('.content-wrapper');
                    if (mainContent) {
                        mainContent.insertBefore(backLink, mainContent.firstChild);
                    }
                }
            }

            // è°ƒç”¨è®¾ç½®è¿”å›æŒ‰é’®çš„å‡½æ•°
            setupBackButton();

            // åˆ·æ–°æŒ‰é’®äº‹ä»¶å¤„ç†ï¼ˆå¢å¼ºç‰ˆï¼‰
            function setupRefreshButton() {
                // å°è¯•è·å–åˆ·æ–°æŒ‰é’®çš„å¤šç§æ–¹å¼
                const refreshBtn = document.getElementById('refreshBtn') ||
                    document.querySelector('[id*="refresh"],[class*="refresh"]') ||
                    document.querySelector('button:contains("åˆ·æ–°")') ||
                    document.querySelector('a:contains("åˆ·æ–°")');

                if (refreshBtn) {
                    console.log('æ‰¾åˆ°åˆ·æ–°æŒ‰é’®ï¼Œç»‘å®šäº‹ä»¶');
                    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
                    const newRefreshBtn = refreshBtn.cloneNode(true);
                    refreshBtn.parentNode.replaceChild(newRefreshBtn, refreshBtn);

                    // é‡æ–°ç»‘å®šäº‹ä»¶
                    newRefreshBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        console.log('åˆ·æ–°æŒ‰é’®ç‚¹å‡»');
                        currentPageNum = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ

                        // æ˜¾ç¤ºåŠ è½½ä¸­æç¤º
                        if (loading) {
                            loading.style.display = 'flex';
                        }

                        // é‡æ–°åŠ è½½æ•°æ®
                        if (typeof loadTeachers === 'function') {
                            console.log('è°ƒç”¨loadTeachers()é‡æ–°åŠ è½½æ•°æ®');
                            loadTeachers();
                        } else {
                            console.error('loadTeacherså‡½æ•°æœªå®šä¹‰');
                        }
                    });
                } else {
                    console.error('æœªæ‰¾åˆ°åˆ·æ–°æŒ‰é’®');
                    // æ·»åŠ å¤‡ç”¨æ–¹æ¡ˆï¼šåœ¨é¡µé¢ä¸Šæ·»åŠ åˆ·æ–°æŒ‰é’®
                    const refreshButton = document.createElement('button');
                    refreshButton.className = 'btn btn-secondary refresh-button';
                    refreshButton.textContent = 'åˆ·æ–°æ•°æ®';

                    refreshButton.addEventListener('click', function () {
                        console.log('å¤‡ç”¨åˆ·æ–°æŒ‰é’®ç‚¹å‡»');
                        currentPageNum = 1;
                        if (typeof loadTeachers === 'function') {
                            loadTeachers();
                        }
                    });

                    const actionBar = document.querySelector('.btn-group') ||
                        document.querySelector('.action-bar') ||
                        document.querySelector('.btn-toolbar') ||
                        document.querySelector('.action-buttons');

                    if (actionBar) {
                        actionBar.appendChild(refreshButton);
                    } else if (document.body) {
                        // å¦‚æœæ‰¾ä¸åˆ°åˆé€‚çš„ä½ç½®ï¼Œå°±æ·»åŠ åˆ°bodyæœ«å°¾
                        document.body.appendChild(refreshButton);
                    }
                }
            }

            // è°ƒç”¨è®¾ç½®åˆ·æ–°æŒ‰é’®çš„å‡½æ•°
            setupRefreshButton();

            // è°ƒè¯•å’ŒåŠŸèƒ½æµ‹è¯•è¾…åŠ©å‡½æ•°
            function testAllFeatures() {
                console.log('====== åŠŸèƒ½æµ‹è¯•å¼€å§‹ ======');

                // 1. æµ‹è¯•å·²é€‰æ‹©æ•™å¸ˆå±•ç¤ºåŠŸèƒ½
                console.log('æµ‹è¯•1: å·²é€‰æ‹©æ•™å¸ˆå±•ç¤º');
                if (typeof updateSelectedCoursesDisplay === 'function') {
                    try {
                        updateSelectedCoursesDisplay();
                        console.log('âœ“ å·²é€‰æ‹©æ•™å¸ˆå±•ç¤ºåŠŸèƒ½æ­£å¸¸');
                    } catch (error) {
                        console.error('âœ— å·²é€‰æ‹©æ•™å¸ˆå±•ç¤ºåŠŸèƒ½é”™è¯¯:', error);
                    }
                }

                // 2. æµ‹è¯•æœ¬åœ°å­˜å‚¨åŠŸèƒ½
                console.log('æµ‹è¯•2: æœ¬åœ°å­˜å‚¨');
                try {
                    const testData = JSON.parse(localStorage.getItem('selectedTeachers') || '[]');
                    console.log('âœ“ æœ¬åœ°å­˜å‚¨è¯»å–æ­£å¸¸ï¼Œå·²é€‰æ‹©æ•™å¸ˆæ•°é‡:', testData.length);
                } catch (error) {
                    console.error('âœ— æœ¬åœ°å­˜å‚¨è¯»å–é”™è¯¯:', error);
                }

                // 3. æµ‹è¯•æŠ˜å /å±•å¼€åŠŸèƒ½
                console.log('æµ‹è¯•3: æŠ˜å /å±•å¼€åŠŸèƒ½');
                const toggleBtn = document.getElementById('toggle-selection-btn');
                if (toggleBtn) {
                    console.log('âœ“ æŠ˜å /å±•å¼€æŒ‰é’®å­˜åœ¨');
                } else {
                    console.warn('âš  æŠ˜å /å±•å¼€æŒ‰é’®æœªæ‰¾åˆ°');
                }

                // 4. æµ‹è¯•è¿”å›æŒ‰é’®
                console.log('æµ‹è¯•4: è¿”å›æŒ‰é’®');
                const backBtnExists = document.getElementById('backBtn') ||
                    document.querySelector('.back-link');
                if (backBtnExists) {
                    console.log('âœ“ è¿”å›æŒ‰é’®å­˜åœ¨');
                } else {
                    console.warn('âš  è¿”å›æŒ‰é’®æœªæ‰¾åˆ°');
                }

                // 5. æµ‹è¯•åˆ·æ–°æŒ‰é’®
                console.log('æµ‹è¯•5: åˆ·æ–°æŒ‰é’®');
                const refreshBtnExists = document.getElementById('refreshBtn') ||
                    document.querySelector('.refresh-button');
                if (refreshBtnExists) {
                    console.log('âœ“ åˆ·æ–°æŒ‰é’®å­˜åœ¨');
                } else {
                    console.warn('âš  åˆ·æ–°æŒ‰é’®æœªæ‰¾åˆ°');
                }

                console.log('====== åŠŸèƒ½æµ‹è¯•ç»“æŸ ======');

                // æ˜¾ç¤ºæµ‹è¯•ç»“æœæç¤º
                setTimeout(() => {
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-info notification-test';
                    notification.style.position = 'fixed';
                    notification.style.bottom = '20px';
                    notification.style.right = '20px';
                    notification.style.zIndex = '9999';
                    notification.innerHTML = `
                        <strong>åŠŸèƒ½æµ‹è¯•å·²å®Œæˆ</strong><br>
                        è¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†æµ‹è¯•ç»“æœã€‚
                    `;

                    document.body.appendChild(notification);

                    // 5ç§’åè‡ªåŠ¨ç§»é™¤é€šçŸ¥
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 5000);
                }, 1000);
            }

            // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæµ‹è¯•
            window.addEventListener('load', function () {
                // å»¶è¿Ÿæ‰§è¡Œæµ‹è¯•ï¼Œç¡®ä¿æ‰€æœ‰DOMå…ƒç´ éƒ½å·²åŠ è½½å®Œæˆ
                setTimeout(testAllFeatures, 1000);
            });

            // ä¸Šä¸€é¡µæŒ‰é’®äº‹ä»¶
            prevPageBtn.addEventListener('click', () => {
                if (currentPageNum > 1) {
                    currentPageNum--;
                    renderTeachersWithPagination();
                }
            });

            // ä¸‹ä¸€é¡µæŒ‰é’®äº‹ä»¶
            nextPageBtn.addEventListener('click', () => {
                const totalPagesNum = Math.ceil(totalRecords / pageSize);
                if (currentPageNum < totalPagesNum) {
                    currentPageNum++;
                    renderTeachersWithPagination();
                }
            });
        });
    </script>
</body>

</html>