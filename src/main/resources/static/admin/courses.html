<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾ç¨‹æ•°æ®å±•ç¤º - Wordæ–‡ä»¶ä¸Šä¼ å¤„ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            color: #1890ff;
            margin: 0;
        }

        .nav-btn {
            display: inline-block;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: all 0.3s;
            background-color: #1890ff;
            color: white;
            text-decoration: none;
        }

        .nav-btn:hover {
            background-color: #40a9ff;
        }

        .content-box {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .toolbar h2 {
            font-size: 20px;
            color: #333;
        }

        .search-box {
            display: flex;
            align-items: center;
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
            margin-right: 10px;
        }

        .search-input:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #1890ff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #40a9ff;
        }

        .btn-default {
            background-color: #ffffff;
            color: #333;
            border: 1px solid #d9d9d9;
        }

        .btn-default:hover {
            border-color: #40a9ff;
            color: #40a9ff;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .data-table th {
            background-color: #fafafa;
            font-weight: 600;
            color: #666;
        }

        .data-table tr {
            cursor: pointer;
            transition: all 0.3s;
        }

        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        .data-table tr.clicked {
            background-color: #e6f7ff;
        }



        .pagination {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 20px;
        }

        .pagination-info {
            margin-right: 20px;
            color: #666;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
        }

        .pagination-btn {
            width: 32px;
            height: 32px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 4px;
            border: 1px solid #d9d9d9;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: #40a9ff;
            color: #40a9ff;
        }

        .pagination-btn.active {
            background-color: #1890ff;
            color: white;
            border-color: #1890ff;
        }

        .pagination-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1890ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 0;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="taskCreationStatus" class="task-status" style="display: none; margin-bottom: 20px;">
            <div id="selected-courses-section" class="mb-4">
                <div
                    class="selected-courses-header d-flex justify-content-between align-items-center bg-light p-3 rounded-top">
                    <h5 class="mb-0">å·²é€‰æ‹©è¯¾ç¨‹ (<span id="selectedCount">0</span>)</h5>
                    <button id="toggleSelectedCourses" class="btn btn-secondary btn-sm">æ”¶èµ·</button>
                </div>

                <div id="selectedCoursesContainer" class="border border-top-0 rounded-bottom selected-courses-container"
                    style="transition: max-height 0.3s ease;">
                    <div id="selectedCoursesList" class="selected-courses-list">
                        <p class="no-selection">æš‚æ— å·²é€‰æ‹©è¯¾ç¨‹</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="header">
            <h1>è¯¾ç¨‹æ•°æ®å±•ç¤º</h1>
            <div>
                <a href="./dashboard.html" class="nav-btn" style="margin-right: 10px;">è¿”å›æ§åˆ¶é¢æ¿</a>
                <a href="/admin/upload.html" class="nav-btn">è¿”å›ä¸Šä¼ é¡µé¢</a>
                <button id="createTaskBtn" class="nav-btn"
                    style="margin-left: 10px; background-color: #52c41a; display: none;">åˆ›å»ºä»»åŠ¡</button>
            </div>
        </div>

        <div class="content-box">
            <div class="toolbar">
                <h2>è¯¾ç¨‹åˆ—è¡¨</h2>
                <div class="search-box">
                    <select id="yearFilter" class="search-input" style="width: 120px; margin-right: 10px;">
                        <option value="">å…¨éƒ¨å¹´ä»½</option>
                        <!-- å¹´ä»½é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </select>
                    <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢è¯¾ç¨‹åç§°" />
                    <button id="searchBtn" class="btn btn-primary">æœç´¢</button>
                    <button id="refreshBtn" class="btn btn-default">åˆ·æ–°</button>
                    <button id="addCourseBtn" class="btn btn-success" style="margin-left: 10px;">æ‰‹åŠ¨æ·»åŠ è¯¾ç¨‹</button>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <span>æ­£åœ¨åŠ è½½è¯¾ç¨‹æ•°æ®ï¼Œè¯·ç¨å€™...</span>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">ğŸ“š</div>
                <div class="empty-state-text">æš‚æ— è¯¾ç¨‹æ•°æ®</div>
            </div>

            <div id="tableContainer" style="display: none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>å¹´ä»½</th>
                            <th>è¯¾ç¨‹ç±»å‹</th>
                            <th>è¯¾ç¨‹åç§°</th>
                            <th>è¯¾ç¨‹æ€§è´¨</th>
                            <th>å­¦åˆ†</th>
                            <th>å®è·µå­¦åˆ†</th>
                            <th>å­¦æœŸ</th>
                            <th>å­¦é™¢</th>
                            <th>æŒ‡æ ‡ç‚¹</th>
                            <th>å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="courseTableBody">
                    </tbody>
                </table>

                <div class="pagination">
                    <div class="pagination-info">å…± <span id="totalCount">0</span> æ¡æ•°æ®ï¼Œç¬¬ <span
                            id="currentPage">1</span>/<span id="totalPages">1</span> é¡µ</div>
                    <div class="pagination-controls">
                        <button id="prevPage" class="pagination-btn" disabled>&lt;</button>
                        <div id="pageButtons" style="display: flex;">
                        </div>
                        <button id="nextPage" class="pagination-btn" disabled>&gt;</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰‹åŠ¨æ·»åŠ è¯¾ç¨‹çš„æ¨¡æ€æ¡† -->
    <div id="addCourseModal" class="modal"
        style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content"
            style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>æ‰‹åŠ¨æ·»åŠ è¯¾ç¨‹</h2>
                <span class="close-modal" style="font-size: 28px; cursor: pointer;">&times;</span>
            </div>

            <form id="addCourseForm">
                <div class="form-row" style="display: flex; flex-wrap: wrap; margin: 0 -10px 15px;">
                    <div class="form-group" style="width: 50%; padding: 0 10px; margin-bottom: 15px;">
                        <label for="courseYear">å¹´ä»½ <span style="color: red;">*</span></label>
                        <input type="number" id="courseYear" class="form-input" required placeholder="è¯·è¾“å…¥å¹´ä»½ï¼Œå¦‚ï¼š2024">
                    </div>

                    <div class="form-group" style="width: 50%; padding: 0 10px; margin-bottom: 15px;">
                        <label for="courseType">è¯¾ç¨‹ç±»å‹ <span style="color: red;">*</span></label>
                        <input type="text" id="courseType" class="form-input" required placeholder="è¯·è¾“å…¥è¯¾ç¨‹ç±»å‹">
                    </div>

                    <div class="form-group" style="width: 100%; padding: 0 10px; margin-bottom: 15px;">
                        <label for="courseName">è¯¾ç¨‹åç§° <span style="color: red;">*</span></label>
                        <input type="text" id="courseName" class="form-input" required placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°">
                    </div>

                    <div class="form-group" style="width: 50%; padding: 0 10px; margin-bottom: 15px;">
                        <label for="courseNature">è¯¾ç¨‹æ€§è´¨</label>
                        <input type="text" id="courseNature" class="form-input" placeholder="è¯·è¾“å…¥è¯¾ç¨‹æ€§è´¨">
                    </div>

                    <div class="form-group" style="width: 50%; padding: 0 10px; margin-bottom: 15px;">
                        <label for="courseCredits">å­¦åˆ†</label>
                        <input type="number" step="0.5" id="courseCredits" class="form-input" placeholder="è¯·è¾“å…¥å­¦åˆ†">
                    </div>

                    <div class="form-group" style="width: 50%; padding: 0 10px; margin-bottom: 15px;">
                        <label for="coursePracticeCredits">å®è·µå­¦åˆ†</label>
                        <input type="number" step="0.5" id="coursePracticeCredits" class="form-input"
                            placeholder="è¯·è¾“å…¥å®è·µå­¦åˆ†">
                    </div>

                    <div class="form-group" style="width: 50%; padding: 0 10px; margin-bottom: 15px;">
                        <label for="courseSemester">å­¦æœŸ</label>
                        <input type="text" id="courseSemester" class="form-input" placeholder="è¯·è¾“å…¥å­¦æœŸï¼Œå¦‚ï¼šç¬¬1å­¦æœŸ">
                    </div>

                    <div class="form-group" style="width: 50%; padding: 0 10px; margin-bottom: 15px;">
                        <label for="courseSchool">å­¦é™¢</label>
                        <input type="text" id="courseSchool" class="form-input" placeholder="è¯·è¾“å…¥å­¦é™¢">
                    </div>

                    <div class="form-group" style="width: 50%; padding: 0 10px; margin-bottom: 15px;">
                        <label for="courseIndicators">æŒ‡æ ‡ç‚¹</label>
                        <input type="text" id="courseIndicators" class="form-input" placeholder="è¯·è¾“å…¥æŒ‡æ ‡ç‚¹">
                    </div>

                    <div class="form-group" style="width: 100%; padding: 0 10px; margin-bottom: 15px;">
                        <label for="courseNotes">å¤‡æ³¨</label>
                        <textarea id="courseNotes" class="form-input" rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯"></textarea>
                    </div>
                </div>

                <div class="form-actions"
                    style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" id="cancelAddCourse" class="btn btn-default">å–æ¶ˆ</button>
                    <button type="submit" id="submitAddCourse" class="btn btn-primary">æäº¤</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ æ¨¡æ€æ¡†çš„æ ·å¼ -->
    <style>
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #40a9ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #1890ff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #40a9ff;
        }

        .btn-default {
            background-color: white;
            border-color: #d9d9d9;
            color: #333;
        }

        .btn-default:hover {
            border-color: #40a9ff;
            color: #40a9ff;
        }

        .btn-success {
            background-color: #52c41a;
            color: white;
        }

        .btn-success:hover {
            background-color: #73d13d;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const isCreateTaskMode = urlParams.get('createTask') === 'true';

            if (isCreateTaskMode) {
                document.getElementById('taskCreationStatus').style.display = 'block';
                document.getElementById('createTaskBtn').style.display = 'inline-block';

                // æ·»åŠ CSSæ ·å¼
                const style = document.createElement('style');
                style.textContent = `
                .selected-courses-container {
                    overflow: hidden;
                    transition: max-height 0.3s ease;
                    /* é»˜è®¤æœ€å¤§é«˜åº¦ï¼Œé€šè¿‡CSSæ§åˆ¶è€Œä¸æ˜¯è¡Œå†…æ ·å¼ */
                    max-height: 300px;
                }
                .selected-courses-container.collapsed {
                    max-height: 0 !important;
                    overflow: hidden;
                }
                .selected-courses-list {
                    padding: 10px 15px;
                }
                .selected-course-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 8px;
                    margin-bottom: 5px;
                    background-color: #f8f9fa;
                    border-radius: 4px;
                    border-left: 3px solid #007bff;
                }
                .selected-course-info {
                    flex: 1;
                }
                .selected-course-delete {
                    background-color: #dc3545;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    padding: 4px 8px;
                    cursor: pointer;
                    font-size: 12px;
                }
                .selected-course-delete:hover {
                    background-color: #c82333;
                }
                .no-selection {
                    text-align: center;
                    color: #6c757d;
                    font-style: italic;
                }
            `;
                document.head.appendChild(style);

                // æ›´æ–°å·²é€‰æ‹©è¯¾ç¨‹æ˜¾ç¤º
                updateSelectedCoursesDisplay();

                // è®¾ç½®æŠ˜å /å±•å¼€æŒ‰é’®äº‹ä»¶
                const toggleBtn = document.getElementById('toggleSelectedCourses');
                const container = document.getElementById('selectedCoursesContainer');

                // ç¡®ä¿å®¹å™¨åˆå§‹çŠ¶æ€ä¸æŠ˜å 
                container.classList.remove('collapsed');
                toggleBtn.textContent = 'æ”¶èµ·';

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                toggleBtn.onclick = function () {
                    if (container.classList.contains('collapsed')) {
                        container.classList.remove('collapsed');
                        this.textContent = 'æ”¶èµ·';
                    } else {
                        container.classList.add('collapsed');
                        this.textContent = 'å±•å¼€';
                    }
                    console.log('æŠ˜å çŠ¶æ€åˆ‡æ¢ä¸º:', container.classList.contains('collapsed'));
                };
            }

            // åˆ›å»ºä»»åŠ¡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('createTaskBtn').addEventListener('click', function () {
                // åç»­å°†å®ç°åˆ›å»ºä»»åŠ¡çš„APIè°ƒç”¨
                alert('å³å°†åˆ›å»ºä»»åŠ¡ï¼Œå°†ä¿å­˜æ‚¨é€‰æ‹©çš„æ•™å¸ˆä¿¡æ¯');
            });
        });

        // çŠ¶æ€ç®¡ç†å·¥å…·å‡½æ•°
        const courseSelectionState = {
            // è·å–å·²é€‰æ‹©çš„è¯¾ç¨‹æ•°æ®
            getSelectedCourses: function () {
                try {
                    const data = localStorage.getItem('selectedTeachers');
                    const courses = data ? JSON.parse(data) : [];
                    const result = Array.isArray(courses) ? courses : [];
                    // console.log('ä»localStorageè·å–çš„è¯¾ç¨‹æ•°æ®:', result); // å‡å°‘æ—¥å¿—å™ªéŸ³
                    return result;
                } catch (error) {
                    console.error('è·å–å·²é€‰æ‹©è¯¾ç¨‹å¤±è´¥:', error);
                    return [];
                }
            },

            // ä¿å­˜è¯¾ç¨‹æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
            saveSelectedCourses: function (courses) {
                try {
                    if (!Array.isArray(courses)) {
                        console.error('ä¿å­˜æ•°æ®æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»æ˜¯æ•°ç»„');
                        return false;
                    }
                    localStorage.setItem('selectedTeachers', JSON.stringify(courses));
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜å·²é€‰æ‹©è¯¾ç¨‹å¤±è´¥:', error);
                    return false;
                }
            },

            // æ¸…ç©ºå·²é€‰æ‹©çš„è¯¾ç¨‹
            clearSelectedCourses: function () {
                try {
                    localStorage.removeItem('selectedTeachers');
                    return true;
                } catch (error) {
                    console.error('æ¸…ç©ºå·²é€‰æ‹©è¯¾ç¨‹å¤±è´¥:', error);
                    return false;
                }
            },

            // éªŒè¯è¯¾ç¨‹æ•°æ®çš„æœ‰æ•ˆæ€§
            validateCourseData: function (course) {
                return course && typeof course === 'object';
            }
        };

        // æ›´æ–°å·²é€‰æ‹©è¯¾ç¨‹çš„æ˜¾ç¤º
        function updateSelectedCoursesDisplay() {
            try {
                // ä½¿ç”¨çŠ¶æ€ç®¡ç†å‡½æ•°è·å–æ•°æ®
                const selectedCourses = courseSelectionState.getSelectedCourses();

                // è·å–DOMå…ƒç´ 
                const coursesList = document.getElementById('selectedCoursesList');
                const countElement = document.getElementById('selectedCount');
                const container = document.getElementById('selectedCoursesContainer');

                // ã€ä¿®æ”¹è¯´æ˜ã€‘æ³¨é‡Šæ‰è¿™æ®µå¼ºåˆ¶å±•å¼€çš„ä»£ç ã€‚
                // å¦åˆ™ç”¨æˆ·ç‚¹å‡»â€œæ”¶èµ·â€åï¼Œå¦‚æœè§¦å‘äº†æ•°æ®æ›´æ–°ï¼ˆä¾‹å¦‚storageäº‹ä»¶ï¼‰ï¼Œåˆ—è¡¨åˆä¼šè‡ªåŠ¨å¼¹å¼€ï¼Œä½“éªŒä¸å¥½ã€‚
                //
                // if (container && container.classList.contains('collapsed') && selectedCourses.length > 0) {
                //     container.classList.remove('collapsed');
                //     const toggleBtn = document.getElementById('toggleSelectedCourses');
                //     if (toggleBtn) {
                //         toggleBtn.textContent = 'æ”¶èµ·';
                //     }
                // }

                // æ›´æ–°è®¡æ•°
                countElement.textContent = selectedCourses.length;

                // æ¸…ç©ºåˆ—è¡¨
                coursesList.innerHTML = '';

                // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„è¯¾ç¨‹
                if (selectedCourses.length === 0) {
                    coursesList.innerHTML = '<p class="no-selection">æš‚æ— å·²é€‰æ‹©è¯¾ç¨‹</p>';
                    return;
                }

                // æ·»åŠ æ¯ä¸ªé€‰ä¸­çš„è¯¾ç¨‹
                selectedCourses.forEach((course, index) => {
                    if (course && typeof course === 'object') {
                        const displayName = course.courseName || course.teacherName || `è¯¾ç¨‹ ${index + 1}`;
                        const displayCode = course.courseCode || `#${index + 1}`;

                        const item = document.createElement('div');
                        item.className = 'selected-course-item';
                        item.dataset.courseCode = course.courseCode || `temp-${index}`;
                        item.innerHTML = `
                        <div class="selected-course-info">
                            <strong>${displayName}</strong> (${displayCode})<br>
                            ${course.teacherName ? `æ•™å¸ˆ: ${course.teacherName}` : ''}
                            ${course.teacherName && course.semester ? ' | ' : ''}
                            ${course.semester ? `å­¦æœŸ: ${course.semester}` : ''}
                        </div>
                        <button class="selected-course-delete" title="åˆ é™¤é€‰æ‹©">åˆ é™¤</button>
                    `;
                        coursesList.appendChild(item);
                    }
                });

                // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬ï¼ˆä½¿ç”¨å§”æ‰˜æ–¹å¼é¿å…é‡å¤ç»‘å®šï¼‰
                coursesList.onclick = function (event) {
                    if (event.target.classList.contains('selected-course-delete')) {
                        const item = event.target.closest('.selected-course-item');
                        const courseCode = item.dataset.courseCode;

                        // ä»localStorageä¸­ç§»é™¤
                        let selectedCourses = JSON.parse(localStorage.getItem('selectedTeachers') || '[]');
                        selectedCourses = selectedCourses.filter(c => c.courseCode !== courseCode);
                        localStorage.setItem('selectedTeachers', JSON.stringify(selectedCourses));

                        // æ›´æ–°æ˜¾ç¤º
                        updateSelectedCoursesDisplay();

                        // æ›´æ–°è¡Œé«˜äº®çŠ¶æ€
                        const courseRow = document.querySelector(`tr[data-course-code="${courseCode}"]`);
                        if (courseRow) {
                            courseRow.classList.remove('selected');
                        }
                    }
                };

            } catch (error) {
                console.error('æ›´æ–°å·²é€‰æ‹©è¯¾ç¨‹æ˜¾ç¤ºæ—¶å‡ºé”™:', error);
                document.getElementById('selectedCoursesList').innerHTML =
                    '<p class="no-selection">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
            }
        }

        // ç›‘å¬localStorageå˜åŒ–ï¼Œå®æ—¶æ›´æ–°æ˜¾ç¤º
        window.addEventListener('storage', function (e) {
            if (e.key === 'selectedTeachers') {
                if (window._storageUpdateTimer) {
                    clearTimeout(window._storageUpdateTimer);
                }
                window._storageUpdateTimer = setTimeout(() => {
                    updateSelectedCoursesDisplay();
                }, 100);
            }
        });

        window.addEventListener('beforeunload', function () {
            if (window._storageUpdateTimer) {
                clearTimeout(window._storageUpdateTimer);
            }
        });

        // å¢å¼ºåˆ›å»ºä»»åŠ¡æŒ‰é’®åŠŸèƒ½ - å®ç°åˆ›å»ºä»»åŠ¡åŠŸèƒ½å’Œæ•°æ®æäº¤åˆ°æ•°æ®åº“
        const createTaskBtn = document.getElementById('createTaskBtn');
        if (createTaskBtn) {
            createTaskBtn.addEventListener('click', function () {
                const selectedCourses = courseSelectionState.getSelectedCourses();

                if (selectedCourses.length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é—¨è¯¾ç¨‹åå†åˆ›å»ºä»»åŠ¡');
                    return;
                }

                // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                const courseNames = selectedCourses
                    .filter(course => courseSelectionState.validateCourseData(course))
                    .map(course => course.courseName || 'æœªå‘½åè¯¾ç¨‹')
                    .join(', ');

                if (!confirm(`ç¡®è®¤åˆ›å»ºä»»åŠ¡å—ï¼Ÿå·²é€‰æ‹© ${selectedCourses.length} é—¨è¯¾ç¨‹:\n${courseNames}`)) {
                    return;
                }

                // å‡†å¤‡ä»»åŠ¡æ•°æ®ï¼ˆä¸åç«¯æ¥å£åŒ¹é…ï¼‰
                const today = new Date();
                // è®¾ç½®æˆªæ­¢æ—¥æœŸä¸º7å¤©å
                const deadlineDate = new Date(today);
                deadlineDate.setDate(today.getDate() + 7);
                const deadline = deadlineDate.toISOString().split('T')[0]; // æ ¼å¼åŒ–ä¸ºyyyy-MM-dd

                const taskData = {
                    taskName: `æ•™å­¦ä»»åŠ¡_${new Date().toLocaleDateString()}`,
                    deadline: deadline,  // åç«¯å¿…éœ€å­—æ®µï¼šæˆªæ­¢æ—¥æœŸ
                    description: `è‡ªåŠ¨åˆ›å»ºçš„æ•™å­¦ä»»åŠ¡ï¼ŒåŒ…å«${selectedCourses.length}é—¨è¯¾ç¨‹`,  // åç«¯å¿…éœ€å­—æ®µï¼šä»»åŠ¡æè¿°
                    teachers: selectedCourses  // åç«¯å¿…éœ€å­—æ®µï¼šæ•™å¸ˆ/è¯¾ç¨‹æ•°æ®ï¼ˆåç«¯æœŸæœ›å­—æ®µåä¸ºteachersï¼‰
                };

                console.log('å‡†å¤‡æäº¤çš„ä»»åŠ¡æ•°æ®:', taskData);

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                this.disabled = true;
                this.textContent = 'æ­£åœ¨åˆ›å»ºä»»åŠ¡...';

                // æäº¤ä»»åŠ¡æ•°æ®åˆ°æ•°æ®åº“
                fetch('/api/tasks/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                        }
                        return response.json();
                    })
                    .then(result => {
                        if (result.success) {
                            // æ¸…ç©ºæœ¬åœ°å­˜å‚¨
                            courseSelectionState.clearSelectedCourses();

                            alert('ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼');
                            // è·³è½¬åˆ°æ§åˆ¶é¢æ¿
                            window.location.href = '/admin/dashboard.html';
                        } else {
                            throw new Error(result.message || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
                        alert(`åˆ›å»ºä»»åŠ¡å¤±è´¥: ${error.message}`);
                    })
                    .finally(() => {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        this.disabled = false;
                        this.textContent = 'åˆ›å»ºä»»åŠ¡';
                    });
            });
        } else {
            console.warn('åˆ›å»ºä»»åŠ¡æŒ‰é’®ä¸å­˜åœ¨ï¼Œè·³è¿‡äº‹ä»¶ç»‘å®š');
        }
    </script>

    <script>
        // ç”Ÿæˆæœ€è¿‘4å¹´çš„å¹´ä»½é€‰é¡¹å‡½æ•°
        function generateYearOptions(testDate = null) {
            const now = testDate || new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // getMonth()è¿”å›0-11

            const yearFilter = document.getElementById('yearFilter');
            if (!yearFilter) return;

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"å…¨éƒ¨å¹´ä»½"ï¼‰
            while (yearFilter.options.length > 1) {
                yearFilter.remove(1);
            }

            // æ ¹æ®æœˆä»½ç¡®å®šåŸºå‡†å¹´ä»½
            // å¦‚æœæ˜¯9-12æœˆæˆ–1-2æœˆï¼Œä»¥å½“å‰å¹´ä»½ä¸ºåŸºå‡†
            // å¦‚æœæ˜¯3-8æœˆï¼Œä»¥ä¸Šä¸€å¹´ä¸ºåŸºå‡†
            let baseYear;
            if ((currentMonth >= 9 && currentMonth <= 12) || (currentMonth >= 1 && currentMonth <= 2)) {
                baseYear = currentYear;
            } else {
                baseYear = currentYear - 1;
            }

            // æ·»åŠ æœ€è¿‘4å¹´çš„é€‰é¡¹ï¼Œä»åŸºå‡†å¹´ä»½å¼€å§‹å¾€ä¸‹å‡
            for (let i = 0; i < 4; i++) {
                const year = baseYear - i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}å¹´`;
                yearFilter.appendChild(option);
            }

            // è°ƒè¯•ä¿¡æ¯
            console.log(`å½“å‰æ—¥æœŸ: ${currentYear}-${currentMonth}`);
            console.log(`åŸºå‡†å¹´ä»½: ${baseYear}`);
            console.log(`ç”Ÿæˆçš„å¹´ä»½é€‰é¡¹: ${Array.from(yearFilter.options).slice(1).map(o => o.value).join(', ')}`);
        }

        // æµ‹è¯•å‡½æ•° - ç”¨äºéªŒè¯ä¸åŒæœˆä»½çš„æƒ…å†µ
        function testYearOptions() {
            console.log('=== å¹´ä»½ç­›é€‰åŠŸèƒ½æµ‹è¯• ===');

            // æµ‹è¯•9æœˆï¼ˆåº”è¯¥æ˜¾ç¤ºå½“å‰å¹´åŠå‰3å¹´ï¼‰
            const currentYear = new Date().getFullYear();
            console.log(`\næµ‹è¯•åœºæ™¯1: ${currentYear}-09`);
            generateYearOptions(new Date(currentYear, 8, 1)); // 9æœˆ

            // æµ‹è¯•2æœˆï¼ˆåº”è¯¥æ˜¾ç¤ºå½“å‰å¹´åŠå‰3å¹´ï¼‰
            console.log(`\næµ‹è¯•åœºæ™¯2: ${currentYear}-02`);
            generateYearOptions(new Date(currentYear, 1, 1)); // 2æœˆ

            // æµ‹è¯•6æœˆï¼ˆåº”è¯¥æ˜¾ç¤ºå‰ä¸€å¹´åŠæ›´å‰3å¹´ï¼‰
            console.log(`\næµ‹è¯•åœºæ™¯3: ${currentYear}-06`);
            generateYearOptions(new Date(currentYear, 5, 1)); // 6æœˆ

            // æ¢å¤ä¸ºå®é™…å½“å‰æ—¥æœŸ
            console.log('\næ¢å¤ä¸ºå®é™…å½“å‰æ—¥æœŸ');
            generateYearOptions();
            console.log('=== æµ‹è¯•å®Œæˆ ===');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ç”Ÿæˆå¹´ä»½é€‰é¡¹
            generateYearOptions();

            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('emptyState');
            const tableContainer = document.getElementById('tableContainer');
            const courseTableBody = document.getElementById('courseTableBody');
            const totalCount = document.getElementById('totalCount');
            const currentPage = document.getElementById('currentPage');
            const totalPages = document.getElementById('totalPages');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const pageButtons = document.getElementById('pageButtons');
            const searchInput = document.getElementById('searchInput');
            const yearFilter = document.getElementById('yearFilter');
            const searchBtn = document.getElementById('searchBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const addCourseBtn = document.getElementById('addCourseBtn');
            const addCourseModal = document.getElementById('addCourseModal');
            const closeModalBtn = document.querySelector('.close-modal');
            const cancelAddCourseBtn = document.getElementById('cancelAddCourse');
            const addCourseForm = document.getElementById('addCourseForm');


            let allCourses = [];
            let filteredCourses = [];
            let currentPageNum = 1;
            const pageSize = 10; // æ¯é¡µæ˜¾ç¤º10æ¡æ•°æ®

            // åŠ è½½è¯¾ç¨‹æ•°æ®
            loadCourses();

            // åˆ·æ–°æŒ‰é’®äº‹ä»¶
            refreshBtn.addEventListener('click', () => {
                searchInput.value = '';
                yearFilter.value = '';
                currentPageNum = 1;
                loadCourses();
            });

            // æœç´¢æŒ‰é’®äº‹ä»¶
            searchBtn.addEventListener('click', () => {
                currentPageNum = 1;
                filterCourses();
            });

            // å¹´ä»½ç­›é€‰å˜åŒ–äº‹ä»¶
            yearFilter.addEventListener('change', () => {
                currentPageNum = 1;
                filterCourses();
            });

            // å›è½¦é”®æœç´¢
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    currentPageNum = 1;
                    filterCourses();
                }
            });

            // æ‰“å¼€æ·»åŠ è¯¾ç¨‹æ¨¡æ€æ¡†
            addCourseBtn.addEventListener('click', () => {
                addCourseModal.style.display = 'block';
                // é‡ç½®è¡¨å•
                addCourseForm.reset();
            });

            // å…³é—­æ¨¡æ€æ¡†
            function closeModal() {
                addCourseModal.style.display = 'none';
            }

            closeModalBtn.addEventListener('click', closeModal);
            cancelAddCourseBtn.addEventListener('click', closeModal);

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', (e) => {
                if (e.target === addCourseModal) {
                    closeModal();
                }
            });

            // è¡¨å•æäº¤å¤„ç†
            addCourseForm.addEventListener('submit', (e) => {
                e.preventDefault();

                // æ”¶é›†è¡¨å•æ•°æ®
                const courseData = {
                    year: document.getElementById('courseYear').value,
                    courseType: document.getElementById('courseType').value,
                    courseName: document.getElementById('courseName').value,
                    nature: document.getElementById('courseNature').value || null,
                    credits: document.getElementById('courseCredits').value ? parseFloat(document.getElementById('courseCredits').value) : null,
                    practiceCredits: document.getElementById('coursePracticeCredits').value ? parseFloat(document.getElementById('coursePracticeCredits').value) : null,
                    semester: document.getElementById('courseSemester').value || null,
                    school: document.getElementById('courseSchool').value || null,
                    indicators: document.getElementById('courseIndicators').value || null,
                    notes: document.getElementById('courseNotes').value || null
                };

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const submitBtn = document.getElementById('submitAddCourse');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'æäº¤ä¸­...';

                // å‘é€è¯·æ±‚ä¿å­˜è¯¾ç¨‹
                fetch('/api/courses/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(courseData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) { // æ£€æŸ¥successå­—æ®µ
                            alert('è¯¾ç¨‹æ·»åŠ æˆåŠŸï¼');
                            closeModal();
                            // é‡æ–°åŠ è½½è¯¾ç¨‹æ•°æ®
                            loadCourses();
                        } else {
                            alert('è¯¾ç¨‹æ·»åŠ å¤±è´¥ï¼š' + (data.error || data.message || 'æœªçŸ¥é”™è¯¯'));
                        }
                    })
                    .catch(error => {
                        console.error('æ·»åŠ è¯¾ç¨‹å¤±è´¥:', error);
                        alert('æ·»åŠ è¯¾ç¨‹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    })
                    .finally(() => {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    });
            });

            // ä¸Šä¸€é¡µæŒ‰é’®äº‹ä»¶
            prevPageBtn.addEventListener('click', () => {
                if (currentPageNum > 1) {
                    currentPageNum--;
                    renderCoursesWithPagination();
                }
            });

            // ä¸‹ä¸€é¡µæŒ‰é’®äº‹ä»¶
            nextPageBtn.addEventListener('click', () => {
                const maxPage = Math.ceil(filteredCourses.length / pageSize);
                if (currentPageNum < maxPage) {
                    currentPageNum++;
                    renderCoursesWithPagination();
                }
            });

            function loadCourses() {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                loading.style.display = 'flex';
                emptyState.style.display = 'none';
                tableContainer.style.display = 'none';

                // è°ƒç”¨APIè·å–è¯¾ç¨‹æ•°æ®
                fetch('/api/courses/all')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                        }
                        return response.json();
                    })
                    .then(courses => {
                        allCourses = courses;
                        filteredCourses = courses;
                        renderCoursesWithPagination();
                    })
                    .catch(error => {
                        console.error('åŠ è½½è¯¾ç¨‹æ•°æ®å¤±è´¥:', error);
                        loading.innerHTML = '<span style="color: #ff4d4f;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</span>';
                    });
            }

            function renderCoursesWithPagination() {
                loading.style.display = 'none';

                // æ›´æ–°æ€»æ•°
                totalCount.textContent = filteredCourses.length;

                if (filteredCourses.length === 0) {
                    emptyState.style.display = 'block';
                    tableContainer.style.display = 'none';
                } else {
                    emptyState.style.display = 'none';
                    tableContainer.style.display = 'block';
                }

                // è®¡ç®—æ€»é¡µæ•°
                const maxPage = Math.ceil(filteredCourses.length / pageSize);

                // æ›´æ–°åˆ†é¡µä¿¡æ¯
                currentPage.textContent = currentPageNum;
                totalPages.textContent = maxPage;

                // å¯ç”¨/ç¦ç”¨åˆ†é¡µæŒ‰é’®
                prevPageBtn.disabled = currentPageNum === 1;
                nextPageBtn.disabled = currentPageNum === maxPage;

                // ç”Ÿæˆé¡µç æŒ‰é’®
                generatePageButtons(maxPage);

                // è®¡ç®—å½“å‰é¡µæ˜¾ç¤ºçš„æ•°æ®
                const startIndex = (currentPageNum - 1) * pageSize;
                const endIndex = Math.min(startIndex + pageSize, filteredCourses.length);
                const currentPageCourses = filteredCourses.slice(startIndex, endIndex);

                // æ¸²æŸ“å½“å‰é¡µçš„è¯¾ç¨‹æ•°æ®
                courseTableBody.innerHTML = '';
                currentPageCourses.forEach((course, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${startIndex + index + 1}</td>
                        <td>${course.year || '-'}</td>
                        <td>${course.courseType || '-'}</td>
                        <td>${course.courseName || '-'}</td>
                        <td>${course.nature || '-'}</td>
                        <td>${course.credits || '-'}</td>
                        <td>${course.practiceCredits || '-'}</td>
                        <td>${course.semester || '-'}</td>
                        <td>${course.school || '-'}</td>
                        <td>${course.indicators || '-'}</td>
                        <td>${course.notes || '-'}</td>
                    `;

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    row.addEventListener('click', function () {
                        // æ„å»ºå­¦æœŸæ ¼å¼: "2025-2026-1"
                        let semester;
                        if (course.year && course.semester) {
                            const year = parseInt(course.year); // å½“å‰å­¦å¹´
                            const semesterStr = course.semester; // å½“å‰å­¦æœŸå­—ç¬¦ä¸²ï¼Œå¦‚â€œç¬¬1å­¦æœŸâ€

                            // æå–å­¦æœŸç¼–å·
                            const semesterNum = semesterStr.match(/\d+/); // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–æ•°å­—
                            if (!semesterNum) {
                                semester = '2025-2026-1'; // å¦‚æœæ— æ³•æå–å­¦æœŸç¼–å·ï¼Œä½¿ç”¨é»˜è®¤å€¼
                            } else {
                                const semesterNumber = parseInt(semesterNum[0]); // æå–çš„å­¦æœŸç¼–å·

                                let startYear;
                                let endYear;
                                let semesterIndex;

                                if (semesterNumber < 1 || semesterNumber > 8) {
                                    semester = '2025-2026-1';
                                } else {
                                    // è®¡ç®— startYear å’Œ endYear
                                    startYear = year + Math.floor((semesterNumber - 1) / 2);
                                    endYear = startYear + 1;

                                    // è®¡ç®— semesterIndex
                                    semesterIndex = (semesterNumber % 2) === 0 ? 2 : 1;

                                    semester = `${startYear}-${endYear}-${semesterIndex}`;
                                }
                            }
                        } else {
                            semester = '2025-2026-1'; // é»˜è®¤å€¼
                        }

                        // æå–è¯¾ç¨‹åç§°ä¸­çš„ä¸­æ–‡éƒ¨åˆ†
                        const extractChineseFromCourseName = (text) => {
                            if (!text) return '';
                            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–ä¸­æ–‡
                            const chinesePattern = /[\u4e00-\u9fa5]+/;
                            const match = text.match(chinesePattern);
                            return match ? match[0] : text;
                        };

                        const courseName = extractChineseFromCourseName(course.courseName || '');

                        // æ„å»ºURLå¹¶è·³è½¬
                        const urlParams = new URLSearchParams(window.location.search);
                        const isCreateTaskMode = urlParams.get('createTask') === 'true';

                        let teachersUrl = `/admin/teachers.html?semester=${encodeURIComponent(semester)}&courseName=${encodeURIComponent(courseName)}`;
                        if (isCreateTaskMode) {
                            teachersUrl += '&createTask=true';
                        }
                        window.location.href = teachersUrl;
                    });

                    courseTableBody.appendChild(row);
                });
            }

            // ç”Ÿæˆé¡µç æŒ‰é’®
            function generatePageButtons(maxPage) {
                pageButtons.innerHTML = '';

                // æ˜¾ç¤ºæœ€å¤š5ä¸ªé¡µç æŒ‰é’®
                let startPage = Math.max(1, currentPageNum - 2);
                let endPage = Math.min(maxPage, startPage + 4);

                // è°ƒæ•´èµ·å§‹é¡µç ï¼Œç¡®ä¿æ˜¾ç¤º5ä¸ªæŒ‰é’®
                if (endPage - startPage < 4) {
                    startPage = Math.max(1, endPage - 4);
                }

                // æ·»åŠ é¡µç æŒ‰é’®
                for (let i = startPage; i <= endPage; i++) {
                    const btn = document.createElement('button');
                    btn.className = `pagination-btn ${i === currentPageNum ? 'active' : ''}`;
                    btn.textContent = i;
                    btn.addEventListener('click', () => {
                        currentPageNum = i;
                        renderCoursesWithPagination();
                    });
                    pageButtons.appendChild(btn);
                }
            }

            function filterCourses() {
                const searchTerm = searchInput.value.trim().toLowerCase();
                const selectedYear = yearFilter.value;

                filteredCourses = allCourses.filter(course => {
                    // å¹´ä»½ç­›é€‰
                    if (selectedYear && (!course.year || course.year.toString() !== selectedYear)) {
                        return false;
                    }

                    // å…³é”®è¯æœç´¢
                    if (!searchTerm) {
                        return true;
                    }

                    return (course.courseName && course.courseName.toLowerCase().includes(searchTerm)) ||
                        (course.courseType && course.courseType.toLowerCase().includes(searchTerm)) ||
                        (course.school && course.school.toLowerCase().includes(searchTerm));
                });

                renderCoursesWithPagination();
            }
        });
    </script>
</body>

</html>